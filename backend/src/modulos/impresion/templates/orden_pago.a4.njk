{# src/modulos/impresion/templates/orden_pago.a4.njk #}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>{{ ui.titulo }}</title>
  <style>
    {% include cssFile %}

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; font-size: 10px; line-height: 1.2; color: #000; background: white; }

    .page { width: 210mm; height: 297mm; margin: 0 auto; background: white; display: flex; flex-direction: column; page-break-after: always; }
    .page:last-child { page-break-after: auto; }

    .copy-section { height: 148.5mm; border-bottom: 1px dashed #999; padding: 8mm; display: flex; flex-direction: column; position: relative; }
    .copy-section:last-child { border-bottom: none; }
    .copy-section.full-page { height: 281mm; border-bottom: none; }

    /* Header común */
    .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 6px; margin-bottom: 8px; }
    .company-info { display: grid; grid-template-columns: auto 1fr; gap: 6px 10px; align-items: center; flex: 1; }
    .company-logo { width: 28mm; height: auto; object-fit: contain; }
    .company-block { line-height: 1.25; }
    .company-name { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
    .company-line { font-size: 9px; color: #111; }

    .document-info { text-align: right; border: 2px solid #000; padding: 6px; min-width: 60mm; }
    .doc-title { font-size: 12px; font-weight: bold; text-align: center; margin-bottom: 4px; }
    .doc-number, .doc-date { font-size: 9px; text-align: center; }
    .page-info { font-size: 8px; text-align: center; color: #666; margin-top: 2px; }

    /* Badge de tipo */
    .copy-badge { position: absolute; top: 3mm; right: 3mm; border: 1px solid #000; padding: 2px 6px; font-size: 8px; font-weight: bold; background: white; }

    /* Beneficiario */
    .beneficiary { margin: 8px 0; border: 1px solid #000; padding: 6px; }
    .beneficiary-title { font-size: 8px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
    .beneficiary-info { display: flex; justify-content: space-between; align-items: center; }
    .beneficiary-name { font-size: 11px; font-weight: bold; }
    .beneficiary-cuit { font-size: 9px; font-family: monospace; }

    /* Continuación */
    .continuation { font-size: 8px; font-style: italic; color: #666; text-align: center; margin: 4px 0; border: 1px dashed #ccc; padding: 2px; }

    /* Tabla */
    .items-table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 9px; flex: 1; }
    .items-table th { border: 1px solid #000; padding: 3px; background: #f0f0f0; font-weight: bold; text-align: left; }
    .items-table th.center { text-align: center; }
    .items-table th.right { text-align: right; }
    .items-table td { border: 1px solid #000; padding: 2px 3px; }
    .items-table td.center { text-align: center; }
    .items-table td.right { text-align: right; font-family: monospace; }

    /* Totales */
    .totals-table { width: 50%; margin-left: auto; border-collapse: collapse; margin-top: 6px; font-size: 9px; }
    .totals-table td { padding: 1px 6px; border-bottom: 1px solid #ccc; }
    .totals-table td:first-child { text-align: left; }
    .totals-table td:last-child { text-align: right; font-family: monospace; font-weight: bold; }
    .totals-table .total-row { border-top: 2px solid #000; border-bottom: 2px solid #000; }
    .totals-table .total-row td { padding: 3px 6px; font-size: 10px; font-weight: bold; }

    /* Notas */
    .notes { margin: 6px 0; padding: 4px; border: 1px solid #ccc; font-size: 8px; font-style: italic; }

    /* Footer */
    .footer { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; border-top: 1px solid #ccc; padding-top: 4px; font-size: 7px; }
    .footer-info { line-height: 1.3; }
    .signature { text-align: center; width: 40mm; }
    .signature-line { width: 40mm; height: 15mm; border-bottom: 1px solid #000; margin-bottom: 2px; }
    .signature-text { font-size: 7px; text-transform: uppercase; }

    /* Línea de corte */
    .cut-line { position: absolute; bottom: 0; left: 10mm; right: 10mm; text-align: center; font-size: 7px; color: #666; }
    .cut-line:before { content: "✂ CORTAR POR ESTA LÍNEA"; background: white; padding: 0 10px; }

    @media print {
      .page { margin: 0; width: 210mm; height: 297mm; }
      body { background: white; }
    }
  </style>
</head>
<body>
  {# Variables de control #}
  {% set allItems = dto.items or [] %}
  {% set totalItems = allItems | length %}
  {% set itemsPerPage = 12 %}

  {# DECISIÓN SIMPLE: ¿Cabe en una página? #}
  {% if totalItems <= itemsPerPage %}

    {# CASO 1: DOCUMENTO SIMPLE - Original y copia en una página #}
    <div class="page">
      {% for label in copies %}
        <div class="copy-section">
          <div class="copy-badge">{{ label | upper }}</div>

          <div class="header">
            <div class="company-info">
              {% if org.logoBase64 %}
                <img class="company-logo" src="{{ org.logoBase64 }}" alt="Logo"/>
              {% endif %}
              <div class="company-block">
                <div class="company-name">{{ org.nombre }}</div>
                {% if org.domicilio %}<div class="company-line">{{ org.domicilio }}</div>{% endif %}
                {% if org.cuit %}<div class="company-line">{{ org.cuit }}</div>{% endif %}
              </div>
            </div>
            <div class="document-info">
              <div class="doc-title">{{ ui.titulo | upper }}</div>
              {% if dto.numero %}<div class="doc-number">N° {{ dto.numero }}</div>{% endif %}
              <div class="doc-date">{{ dto.fecha | dateAR }}</div>
            </div>
          </div>

          <div class="beneficiary">
            <div class="beneficiary-title">Beneficiario</div>
            <div class="beneficiary-info">
              <div class="beneficiary-name">
                {% if dto.tercero and dto.tercero.nombre %}{{ dto.tercero.nombre }}{% else %}—{% endif %}
              </div>
              <div class="beneficiary-cuit">
                CUIT:
                {% if dto.tercero and dto.tercero.cuit %}{{ dto.tercero.cuit }}{% else %}—{% endif %}
              </div>
            </div>
          </div>

          <table class="items-table">
            <thead>
              <tr>
                <th style="width: 60%;">Descripción</th>
                <th class="center" style="width: 8%;">Cant.</th>
                <th class="right" style="width: 16%;">P. Unit</th>
                <th class="right" style="width: 16%;">Importe</th>
              </tr>
            </thead>
            <tbody>
              {% for it in allItems %}
                {% set imp = (it.importe if (it.importe is defined and it.importe is not none) else ((it.cantidad or 1) * (it.pUnit or 0))) %}
                <tr>
                  <td>{{ it.desc }}</td>
                  <td class="center">{{ it.cantidad or 1 }}</td>
                  <td class="right">{{ (it.pUnit or 0) | money }}</td>
                  <td class="right">{{ imp | money }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <table class="totals-table">
            <tr>
              <td>Subtotal:</td>
              <td>
                {% if dto.subtotal is defined and dto.subtotal is not none %}
                  {{ dto.subtotal | money }}
                {% else %}
                  {{ dto.total | money }}
                {% endif %}
              </td>
            </tr>
            <tr><td>Descuentos:</td><td>{{ (dto.descuentos or 0) | money }}</td></tr>
            <tr><td>Percepciones:</td><td>{{ (dto.percepciones or 0) | money }}</td></tr>
            <tr><td>Impuestos:</td><td>{{ (dto.impuestos or 0) | money }}</td></tr>
            <tr class="total-row"><td>TOTAL:</td><td>{{ dto.total | money }}</td></tr>
          </table>

          {% if dto.notas %}
            <div class="notes"><strong>Observaciones:</strong> {{ dto.notas }}</div>
          {% endif %}

          <div class="footer">
            <div class="footer-info">
              <div><strong>{{ org.nombre }}</strong></div>
              {% if org.domicilio %}<div>{{ org.domicilio }}</div>{% endif %}
              {% if org.cuit %}<div>{{ org.cuit }}</div>{% endif %}
            </div>
            <div class="signature">
              <div class="signature-line"></div>
              <div class="signature-text">Firma y Aclaración</div>
            </div>
          </div>

        </div>

        {% if not loop.last %}
          <div class="cut-line"></div>
        {% endif %}
      {% endfor %}
    </div>

  {% else %}

    {# CASO 2: DOCUMENTO COMPLEJO - Múltiples páginas #}
    {% for copyLabel in copies %}
      {% set totalPages = ((totalItems + itemsPerPage - 1) / itemsPerPage) | int %}

      {% for pageNum in range(1, totalPages + 1) %}
        {% set startIdx = (pageNum - 1) * itemsPerPage %}
        {% set endIdx = [startIdx + itemsPerPage, totalItems] | min %}

        <div class="page">
          <div class="copy-section full-page">
            <div class="copy-badge">{{ copyLabel | upper }}</div>

            <div class="header">
              <div class="company-info">
                {% if org.logoBase64 %}
                  <img class="company-logo" src="{{ org.logoBase64 }}" alt="Logo"/>
                {% endif %}
                <div class="company-block">
                  <div class="company-name">{{ org.nombre }}</div>
                  {% if org.domicilio %}<div class="company-line">{{ org.domicilio }}</div>{% endif %}
                  {% if org.cuit %}<div class="company-line">{{ org.cuit }}</div>{% endif %}
                </div>
              </div>
              <div class="document-info">
                <div class="doc-title">{{ ui.titulo | upper }}</div>
                {% if dto.numero %}<div class="doc-number">N° {{ dto.numero }}</div>{% endif %}
                <div class="doc-date">{{ dto.fecha | dateAR }}</div>
                <div class="page-info">Página {{ pageNum }} de {{ totalPages }}</div>
              </div>
            </div>

            {% if pageNum == 1 %}
              <div class="beneficiary">
                <div class="beneficiary-title">Beneficiario</div>
                <div class="beneficiary-info">
                  <div class="beneficiary-name">
                    {% if dto.tercero and dto.tercero.nombre %}{{ dto.tercero.nombre }}{% else %}—{% endif %}
                  </div>
                  <div class="beneficiary-cuit">
                    CUIT: {% if dto.tercero and dto.tercero.cuit %}{{ dto.tercero.cuit }}{% else %}—{% endif %}
                  </div>
                </div>
              </div>
            {% else %}
              <div class="continuation">
                Continuación - Beneficiario:
                {% if dto.tercero and dto.tercero.nombre %}{{ dto.tercero.nombre }}{% else %}—{% endif %}
              </div>
            {% endif %}

            <table class="items-table">
              <thead>
                <tr>
                  <th style="width: 60%;">Descripción</th>
                  <th class="center" style="width: 8%;">Cant.</th>
                  <th class="right" style="width: 16%;">P. Unit</th>
                  <th class="right" style="width: 16%;">Importe</th>
                </tr>
              </thead>
              <tbody>
                {% for i in range(startIdx, endIdx) %}
                  {% set it = allItems[i] %}
                  {% set imp = (it.importe if (it.importe is defined and it.importe is not none) else ((it.cantidad or 1) * (it.pUnit or 0))) %}
                  <tr>
                    <td>{{ it.desc }}</td>
                    <td class="center">{{ it.cantidad or 1 }}</td>
                    <td class="right">{{ (it.pUnit or 0) | money }}</td>
                    <td class="right">{{ imp | money }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            {% if pageNum == totalPages %}
              <table class="totals-table">
                <tr>
                  <td>Subtotal:</td>
                  <td>
                    {% if dto.subtotal is defined and dto.subtotal is not none %}
                      {{ dto.subtotal | money }}
                    {% else %}
                      {{ dto.total | money }}
                    {% endif %}
                  </td>
                </tr>
                <tr><td>Descuentos:</td><td>{{ (dto.descuentos or 0) | money }}</td></tr>
                <tr><td>Percepciones:</td><td>{{ (dto.percepciones or 0) | money }}</td></tr>
                <tr><td>Impuestos:</td><td>{{ (dto.impuestos or 0) | money }}</td></tr>
                <tr class="total-row"><td>TOTAL:</td><td>{{ dto.total | money }}</td></tr>
              </table>

              {% if dto.notas %}
                <div class="notes"><strong>Observaciones:</strong> {{ dto.notas }}</div>
              {% endif %}
            {% endif %}

            <div class="footer">
              <div class="footer-info">
                <div><strong>{{ org.nombre }}</strong></div>
                {% if org.domicilio %}<div>{{ org.domicilio }}</div>{% endif %}
                {% if org.cuit %}<div>{{ org.cuit }}</div>{% endif %}
              </div>
              {% if pageNum == totalPages %}
                <div class="signature">
                  <div class="signature-line"></div>
                  <div class="signature-text">Firma y Aclaración</div>
                </div>
              {% endif %}
            </div>

          </div>
        </div>
      {% endfor %}
    {% endfor %}
  {% endif %}
</body>
</html>
